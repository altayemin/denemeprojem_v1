<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Veri Görselleştirme</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <h1>Veri Görselleştirme</h1>
  <button id="saveBtn">Kaydet (PDF)</button>
  <div id="charts-container" style="display: flex; flex-wrap: wrap;"></div>

  <!-- 3 Tablonun Eklendiği Alan -->
  <div style="margin-top: 60px;">
    <h2>Sıcaklık ve Nem Verileri</h2>
    <table id="tempHumTable" border="1" cellpadding="5" cellspacing="0"></table>

    <h2 style="margin-top: 40px;">Su Debisi Verileri</h2>
    <table id="sd1Table" border="1" cellpadding="5" cellspacing="0"></table>

    <h2 style="margin-top: 40px;">HS1 Verileri</h2>
    <table id="hs1Table" border="1" cellpadding="5" cellspacing="0"></table>
  </div>

  <script>
    const fieldList = [
      "zaman",
      "T1", "H1", "T2", "H2", "T3", "H3", "T4", "H4",
      "T5", "H5", "T6", "H6", "T7", "H7", "T8", "H8",
      "HS1", "SD1"
    ];

    const chartData = {};
    const charts = {};
    let previousTimestamp = null;
    let previousSD1Timestamp = null;
    let previousSD1Value = null;
    const MAX_POINTS = 30;

    function createCharts() {
      const container = document.getElementById("charts-container");
      fieldList.forEach(field => {
        if (field === "zaman") return;
        const div = document.createElement("div");
        div.style.width = "400px";
        div.style.height = "250px";
        div.style.margin = "10px";
        div.innerHTML = `<canvas id="${field}"></canvas><div id="${field}-value">Son Değer: -</div>`;
        container.appendChild(div);

        chartData[field] = {
          labels: [],
          data: []
        };

        charts[field] = new Chart(document.getElementById(field), {
          type: "line",
          data: {
            labels: chartData[field].labels,
            datasets: [{
              label: field,
              data: chartData[field].data,
              fill: false,
              borderColor: "blue",
              tension: 0.1
            }]
          },
          options: {
            responsive: false,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: { maxRotation: 90, minRotation: 45 }
              },
              y: {
                beginAtZero: true
              }
            }
          }
        });
      });
    }

    function createTableHeaders() {
      const tempHumTable = document.getElementById("tempHumTable");
      const thRow = document.createElement("tr");
      thRow.innerHTML = "<th>zaman</th>";
      for (let i = 1; i <= 8; i++) {
        thRow.innerHTML += `<th>T${i}</th><th>H${i}</th>`;
      }
      tempHumTable.appendChild(thRow);

      document.getElementById("sd1Table").innerHTML = "<tr><th>zaman</th><th>SD1</th></tr>";
      document.getElementById("hs1Table").innerHTML = "<tr><th>zaman</th><th>HS1</th></tr>";
    }

    function appendToTempHumTable(data) {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${data.zaman}</td>`;
      for (let i = 1; i <= 8; i++) {
        row.innerHTML += `<td>${data[`T${i}`]}</td><td>${data[`H${i}`]}</td>`;
      }
      document.getElementById("tempHumTable").appendChild(row);
    }

    function appendToHS1Table(data) {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${data.zaman}</td><td>${data.HS1}</td>`;
      document.getElementById("hs1Table").appendChild(row);
    }

    function appendToSD1Table(data) {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${data.zaman}</td><td>${data.SD1}</td>`;
      document.getElementById("sd1Table").appendChild(row);
    }

    function updateChartsExceptSD1(newData) {
      const timestamp = newData["zaman"];
      if (timestamp === previousTimestamp) return;
      previousTimestamp = timestamp;

      fieldList.forEach(field => {
        if (field === "zaman" || field === "SD1") return;
        const val = parseFloat(newData[field]);
        if (!isNaN(val)) {
          const chart = chartData[field];
          chart.labels.push(timestamp);
          chart.data.push(val);
          if (chart.labels.length > MAX_POINTS) {
            chart.labels.shift();
            chart.data.shift();
          }
          document.getElementById(`${field}-value`).textContent = `Son Değer: ${val.toFixed(2)}`;
          charts[field].update();
        }
      });

      appendToTempHumTable(newData);
      appendToHS1Table(newData);
    }

    async function fetchData() {
      try {
        const response = await fetch("data.csv");
        const csvText = await response.text();
        const lines = csvText.trim().split("\n");
        const lastLine = lines[lines.length - 1];
        const values = lastLine.split(",");
        const newData = {};
        fieldList.forEach((field, index) => {
          newData[field] = values[index];
        });
        updateChartsExceptSD1(newData);
      } catch (error) {
        console.error("Veri alınamadı:", error);
      }
    }

    async function fetchSD1Data() {
      try {
        const response = await fetch("sd1.csv");
        const csvText = await response.text();
        const lines = csvText.trim().split("\n");
        const lastLine = lines[lines.length - 1];
        const [timestamp, value] = lastLine.split(",");
        if (timestamp !== previousSD1Timestamp && !isNaN(value)) {
          previousSD1Timestamp = timestamp;
          previousSD1Value = value;

          const chart = chartData["SD1"];
          chart.labels.push(timestamp);
          chart.data.push(parseFloat(value));
          if (chart.labels.length > MAX_POINTS) {
            chart.labels.shift();
            chart.data.shift();
          }
          document.getElementById("SD1-value").textContent = `Son Değer: ${parseFloat(value).toFixed(2)}`;
          charts["SD1"].update();

          appendToSD1Table({ zaman: timestamp, SD1: value });
        }
      } catch (error) {
        console.error("SD1 verisi alınamadı:", error);
      }
    }

    document.getElementById("saveBtn").onclick = async () => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");

      const chartPairs = [
        ["T1", "H1"], ["T2", "H2"], ["T3", "H3"], ["T4", "H4"],
        ["T5", "H5"], ["T6", "H6"], ["T7", "H7"], ["T8", "H8"]
      ];

      for (let page = 0; page < 2; page++) {
        if (page > 0) pdf.addPage();
        for (let i = page * 4; i < (page + 1) * 4; i++) {
          const [temp, hum] = chartPairs[i];
          const tempCanvas = document.getElementById(temp);
          const humCanvas = document.getElementById(hum);

          const tempImg = tempCanvas.toDataURL("image/png", 1.0);
          const humImg = humCanvas.toDataURL("image/png", 1.0);

          pdf.setFontSize(8);
          pdf.text(temp, 10, 5 + (i % 4) * 50);
          pdf.text(hum, 110, 5 + (i % 4) * 50);

          pdf.addImage(tempImg, "PNG", 10, 10 + (i % 4) * 50, 90, 45);
          pdf.addImage(humImg, "PNG", 110, 10 + (i % 4) * 50, 90, 45);
        }
      }

      pdf.addPage();
      pdf.addImage(document.getElementById("HS1").toDataURL("image/png", 1.0), "PNG", 10, 10, 90, 45);
      pdf.addImage(document.getElementById("SD1").toDataURL("image/png", 1.0), "PNG", 110, 10, 90, 45);

      // Tablolar
      const tempTableCanvas = await html2canvas(document.getElementById("tempHumTable"));
      const tempImg = tempTableCanvas.toDataURL("image/png", 1.0);
      pdf.addPage();
      pdf.addImage(tempImg, "PNG", 10, 10, 190, 0);

      const sd1Canvas = await html2canvas(document.getElementById("sd1Table"));
      const sd1Img = sd1Canvas.toDataURL("image/png", 1.0);
      pdf.addPage();
      pdf.addImage(sd1Img, "PNG", 10, 10, 190, 0);

      const hs1Canvas = await html2canvas(document.getElementById("hs1Table"));
      const hs1Img = hs1Canvas.toDataURL("image/png", 1.0);
      pdf.addPage();
      pdf.addImage(hs1Img, "PNG", 10, 10, 190, 0);

      pdf.save("veriler.pdf");
    };

    createCharts();
    createTableHeaders();
    setInterval(fetchData, 3000);
    setInterval(fetchSD1Data, 3000);
  </script>
</body>
</html>















